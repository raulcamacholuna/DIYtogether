<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Configuraci√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 20px; color: white; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; gap: 15px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h3 { color: #5a67d8; font-size: 1.4em; word-break: break-all; margin: 0; display: flex; align-items: center; gap: 10px; }
        .card h4 { color: #4a5568; font-size: 1.1em; margin-top: 20px; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; }
        .card-subtitle { font-size: 0.95em; color: #718096; margin: 5px 0 20px; }
        .btn { border: none; padding: 10px 20px; border-radius: 25px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #4fd1c7 0%, #06b6d4 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #fc8181 0%, #f56565 100%); color: white; }
        .btn-rename { background: linear-gradient(135deg, #3a86ff 0%, #2c6fcc 100%); color: white; }
        .btn-small { padding: 6px 12px; font-size: 12px; border-radius: 15px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 10px 20px; font-size: 16px; font-weight: 600; cursor: pointer; border: none; background-color: rgba(255, 255, 255, 0.2); color: white; border-radius: 10px; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .tab-btn:hover { background-color: rgba(255, 255, 255, 0.4); }
        .tab-btn.active { background-color: white; color: #5a67d8; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .content-panel { display: none; }
        .content-panel.active { display: block; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; color: #4a5568; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 16px; }
        .form-group input[type="range"] { padding: 0; }
        .range-group { display: flex; align-items: center; gap: 15px; }
        .range-group span { font-weight: bold; color: #5a67d8; min-width: 40px; text-align: right; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-actions { display: flex; gap: 10px; }
        .header-actions .btn { width: 42px; height: 42px; font-size: 20px; padding: 0; }

        .file-list { min-height: 250px; max-height: 400px; overflow-y: auto; border: 2px dashed #e2e8f0; border-radius: 10px; transition: all 0.3s ease; }
        .file-list.dragover { border-color: #5a67d8; background: rgba(90, 103, 216, 0.05); }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f2f5; }
        .file-actions { display: flex; gap: 8px; }

        .upload-progress-container { margin-top: 15px; }
        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #48bb78, #38a169); border-radius: 4px; }
        .status { font-size: 0.9em; color: #718096; margin-top: 8px; display: block; min-height: 1.2em; }
        .hidden { display: none !important; }
        .danger-zone { border: 2px solid #f56565; border-radius: 10px; padding: 15px; margin-top: 20px; background-color: #fff5f5; }
        .danger-zone h4 { color: #c53030; border-color: #fed7d7; }

        /* --- INICIO: Estilos FIYndex --- */
        .fiyndex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .fiy-card { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; text-align: center; transition: all 0.3s ease; position: relative; overflow: hidden; }
        .fiy-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .fiy-image { width: 100px; height: 100px; margin: 0 auto 10px; background-color: #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2.5em; color: #a0aec0; }
        .fiy-image img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .fiy-info h5 { margin: 0 0 2px; color: #2d3748; font-size: 1em; }
        .fiy-info p { margin: 0; color: #718096; font-size: 0.8em; }
        .status-icons { position: absolute; top: 8px; right: 8px; display: flex; flex-direction: column; gap: 5px; }
        .status-icon { width: 20px; height: 20px; background-color: rgba(255,255,255,0.7); border-radius: 50%; padding: 3px; }
        .status-icon svg { width: 100%; height: 100%; fill: #a0aec0; transition: fill 0.3s ease; }
        .status-icon.unlocked svg { fill: #48bb78; } /* Verde para desbloqueado */
        .btn-edit { position: absolute; bottom: 8px; right: 8px; padding: 4px 8px; font-size: 12px; border-radius: 8px; background: #5a67d8; color: white; border: none; cursor: pointer; opacity: 0; transition: opacity 0.3s ease; }
        .fiy-card:hover .btn-edit { opacity: 1; }
        /* Estilos para estado bloqueado */
        .fiy-card.locked { background: #fff; }
        .fiy-card.locked .fiy-image, .fiy-card.locked .fiy-info, .fiy-card.locked .status-icons { filter: grayscale(1) brightness(0.8); opacity: 0.6; }
        .fiy-card.locked .fiy-info h5 { color: #a0aec0; }
        .fiy-card.locked:hover { transform: none; box-shadow: none; }
        .fiyndex-grid .fiy-image { background-color: #667eea; color: white; font-weight: bold; }
        .fiy-card.locked .fiy-image { background-color: #e2e8f0; color: #a0aec0; }
        /* --- FIN: Estilos FIYndex --- */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMjAuNSA1SDMuNUMzLjIzIDUgMyA1LjIzIDMgNS41VjE4LjVDMyAxOC43NyAzLjIzIDE5IDMuNSAxOUgyMC41QzIwLjc3IDE5IDIxIDE4Ljc3IDIxIDE4LjVWMi41QzIxIDIuMjMgMjAuNzcgMiAyMC41IDJIOS41TDMgOC41VjE4LjVDMyAxOS44OCAxLjU3IDIxIDAgMjFDMS43MyAyMSAzIDExLjUgMyA4LjVWNS41QzMgNS4yMyAzLjIzIDUgMy41IDVIMjAuNUMyMC43NyA1IDIxIDUuMjMgMjEgNS41VjE4LjVDMjEgMTguNzcgMjAuNzcgMTkgMjAuNSAxOUgzLjVDMy4yMyAxOSAzIDE4Ljc3IDMgMTguNVYxNy41IiBmaWxsPSJ3aGl0ZSIvPjxwYXRoIGQPSJNMjAuNSA1SDMuNUMzLjIzIDUgMyA1LjIzIDMgNS41VjIwLjVDMyAyMC43NyAzLjIzIDIxIDMuNSAyMUgyMC41QzIwLjc3IDIxIDIxIDIwLjc3IDIxIDIwLjVWM1LjVDMjEgNS4yMyAyMC43NyA1IDIwLjUgNVoiIGZpbGw9InVybCgjYSkiLz48cGF0aCBkPSJNMjAuNSA1SDMuNUMzLjIzIDUgMyA1LjIzIDMgNS41VjIwLjVDMyAyMC43NyAzLjIzIDIxIDMuNSAyMUgyMC41QzIwLjc3IDIxIDIxIDIwLjc3IDIxIDIwLjVWMi41QzIxIDIuMjMgMjAuNzcgMiAyMC41IDJIOS41TDQgN0gyMC41QzIwLjc3IDcgMjEgNy4yMyAyMSA3LjVWMThMDIwLjUgNVoiIGZpbGw9InVybCgjYikiLz48cGF0aCBkPSJNMjAuNSA1SDMuNUMzLjIzIDUgMyA1LjIzIDMgNS41VjE4LjVDMyAxOC43NyAzLjIzIDE5IDMuNSAxOUgyMC41QzIwLjc3IDE5IDIxIDE4Ljc3IDIxIDE4LjVWMi41QzIxIDIuMjMgMjAuNzcgMiAyMC41IDJIOS41TDQgN0gyMC41QzIwLjc3IDcgMjEgNy4yMyAyMSA3LjVWMThMMjAuNSA1WiIgZmlsbD0id2hpdGUiIGZpbGwtb3BhY2l0eT0iLjMiLz48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImEiIHgxPSIyMSIgeDI9IjMiIHkxPSIyMSIgeTI9IjUiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj48c3RvcCBzdG9wLWNvbG9yPSIjZmFiYzQ1Ii8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjZmY4YzQ0Ii8+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQgaWQ9ImIiIHgxPSIyMSIgeDI9IjMiIHkxPSIyMSIgeTI9IjUiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj48c3RvcCBzdG9wLWNvbG9yPSIjZmFiYzQ1Ii8+PHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjZmY4YzQ0Ii8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PC9zdmc+"> Portal de Configuraci√≥n</h1>
            <p>Gestiona el WiFi y los archivos de tu dispositivo</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-target="#wifi-panel">üì∂ WiFi</button>
            <button class="tab-btn" data-target="#files-panel">üìÅ Archivos</button>
            <button class="tab-btn" data-target="#settings-panel">‚öôÔ∏è Configuraci√≥n</button>
            <button class="tab-btn" data-target="#index-panel">üåç FIYndex</button>
        </div>

        <div class="tab-content">
            <div id="wifi-panel" class="content-panel active">
                <div class="card">
                    <h3>üì∂ Configuraci√≥n WiFi</h3>
                    <p class="card-subtitle">Conecta tu dispositivo a la red local.</p>
                    <form id="wifi-form">
                        <div class="form-group"><label for="ssid">SSID (Nombre de red)</label><input type="text" id="ssid" name="ssid" required></div>
                        <div class="form-group"><label for="password">Contrase√±a</label><input type="password" id="password" name="password"></div>
                        <div class="form-group"><label for="authmode">Seguridad</label><select id="authmode" name="authmode"><option value="0">Autom√°tico</option><option value="1" selected>WPA2</option><option value="2">WPA3</option></select></div>
                        <button type="submit" class="btn btn-primary" id="save-wifi-btn">üíæ Guardar y Reiniciar</button>
                    </form>
                    <div id="wifi-status" class="status"></div>
                </div>
            </div>

            <div id="files-panel" class="content-panel">
                <div class="card">
                    <div class="card-header">
                        <h3><span id="current-path-display">/</span></h3>
                        <div class="header-actions">
                            <button class="btn btn-primary" id="upload-btn" title="Subir Archivo">üì§</button>
                            <button class="btn btn-secondary" id="create-file-btn" title="Crear Archivo">‚ûïüìÑ</button>
                            <button class="btn btn-secondary" id="create-folder-btn" title="Crear Carpeta">‚ûïüìÅ</button>
                            <button class="btn btn-secondary" id="refresh-btn" title="Actualizar">üîÑ</button>
                        </div>
                    </div>
                    <div class="file-list" id="file-list"></div>
                    <div class="upload-progress-container"><div class="progress-bar"><div class="progress-fill" id="upload-progress" style="width:0%"></div></div><span id="upload-status" class="status"></span></div>
                    <input type="file" id="file-input" multiple class="hidden">
                </div>
            </div>

            <div id="settings-panel" class="content-panel">
                <div class="card">
                    <h3>‚öôÔ∏è Configuraci√≥n del Dispositivo</h3>
                    <p class="card-subtitle">Ajusta los par√°metros de funcionamiento del dispositivo.</p>
                    <form id="settings-form">
                        <h4>General</h4>
                        <div class="form-group">
                            <label for="hostname">Nombre del Dispositivo (Hostname)</label>
                            <input type="text" id="hostname" name="hostname" placeholder="Mi-Tamagotchi-C6">
                        </div>
                        <div class="form-group">
                            <label for="timezone">Zona Horaria</label>
                            <select id="timezone" name="timezone">
                                <option value="Etc/UTC">UTC</option>
                                <option value="Europe/Madrid">Europa/Madrid (CET)</option>
                                <option value="America/New_York">Am√©rica/Nueva York (EST)</option>
                                <option value="America/Mexico_City">Am√©rica/Ciudad de M√©xico (CST)</option>
                                <option value="America/Bogota">Am√©rica/Bogot√° (COT)</option>
                            </select>
                        </div>

                        <h4>Pantalla y Energ√≠a</h4>
                        <div class="form-group">
                            <label for="brightness">Brillo de Pantalla</label>
                            <div class="range-group">
                                <input type="range" id="brightness" name="brightness" min="10" max="100" step="5" value="80">
                                <span id="brightness-value">80%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="screen_timeout">Apagar Pantalla (inactividad)</label>
                            <select id="screen_timeout" name="screen_timeout">
                                <option value="30">30 segundos</option>
                                <option value="60">1 minuto</option>
                                <option value="300">5 minutos</option>
                                <option value="600">10 minutos</option>
                                <option value="0">Nunca</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary" id="save-settings-btn">üíæ Guardar Cambios</button>
                    </form>
                    <div id="settings-status" class="status"></div>
                </div>

                <div class="card">
                    <h4>Sistema y Mantenimiento</h4>
                     <div class="form-group">
                        <label>Firmware</label>
                        <button type="button" class="btn btn-secondary" id="check-ota-btn">üì° Buscar Actualizaciones</button>
                        <div id="ota-status" class="status"></div>
                    </div>
                    <div class="danger-zone">
                        <h4>‚ö†Ô∏è Zona de Peligro</h4>
                        <div class="form-group">
                            <label>Acciones del Dispositivo</label>
                            <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                                <button type="button" class="btn btn-secondary" id="reboot-btn">üîÑ Reiniciar Dispositivo</button>
                                <button type="button" class="btn btn-danger" id="factory-reset-btn">üí• Restaurar de F√°brica</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="index-panel" class="content-panel">
                <div class="card">
                    <h3>üåç FIYndex - Tu colecci√≥n de DIYTogethers</h3>
                    <p class="card-subtitle">Descubre todas las criaturas que has visto o criado.</p>
                    <div id="fiyndex-grid" class="fiyndex-grid">
                        <!-- El contenido se generar√° din√°micamente aqu√≠ -->
                    </div>
                    <div id="fiyndex-status" class="status"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let filesTabLoaded = false;

            // --- L√ìGICA DE PESTA√ëAS ---
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.content-panel').forEach(panel => panel.classList.remove('active'));
                    const targetPanel = document.querySelector(button.dataset.target);
                    targetPanel.classList.add('active');
                    
                    switch (targetPanel.id) {
                        case 'settings-panel':
                            loadDeviceSettings();
                            break;
                        case 'index-panel':
                            loadFiyndexData();
                            break;
                        case 'files-panel':
                            if (!filesTabLoaded) {
                                fetchFileList('/');
                                filesTabLoaded = true;
                            }
                            break;
                    }
                });
            });

            // --- L√ìGICA WIFI ---
            const wifiForm = document.getElementById('wifi-form');
            wifiForm.addEventListener('submit', async e => {
                e.preventDefault();
                const btn = document.getElementById('save-wifi-btn');
                const status = document.getElementById('wifi-status');
                btn.disabled = true;
                btn.textContent = 'Guardando...';
                status.textContent = 'Enviando credenciales...';
                try {
                    const response = await fetch('/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: new URLSearchParams(new FormData(wifiForm)).toString()
                    });
                    if (!response.ok) throw new Error(`Error del servidor: ${response.statusText}`);
                    status.innerHTML = '<span style="color:green">‚úÖ Guardado. El dispositivo se reiniciar√° para aplicar los cambios.</span>';
                    setTimeout(() => status.textContent = '', 5000);
                } catch (err) {
                    status.innerHTML = `<span style="color:red">‚ùå Error: ${err.message}</span>`;
                    btn.disabled = false;
                    btn.textContent = 'üíæ Guardar y Reiniciar';
                }
            });
            
            // --- L√ìGICA DE CONFIGURACI√ìN ---
            const settingsForm = document.getElementById('settings-form');
            const brightnessSlider = document.getElementById('brightness');
            const brightnessValue = document.getElementById('brightness-value');
            
            const loadDeviceSettings = async () => {
                try {
                    const response = await fetch('/getsettings');
                    if (!response.ok) throw new Error('No se pudieron cargar las configuraciones.');
                    const settings = await response.json();
                    
                    document.getElementById('hostname').value = settings.hostname || '';
                    document.getElementById('timezone').value = settings.timezone || 'Etc/UTC';
                    brightnessSlider.value = settings.brightness || 80;
                    brightnessValue.textContent = `${brightnessSlider.value}%`;
                    document.getElementById('screen_timeout').value = settings.screen_timeout || 300;
                } catch (e) {
                    document.getElementById('settings-status').innerHTML = `<span style="color:red">‚ùå Error al cargar configuraci√≥n: ${e.message}</span>`;
                }
            };
            
            brightnessSlider.addEventListener('input', e => {
                brightnessValue.textContent = `${e.target.value}%`;
            });
            
            settingsForm.addEventListener('submit', async e => {
                e.preventDefault();
                const btn = document.getElementById('save-settings-btn');
                const status = document.getElementById('settings-status');
                btn.disabled = true;
                btn.textContent = 'Guardando...';
                status.textContent = 'Aplicando cambios...';
                try {
                    const response = await fetch('/savesettings', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                        body: new URLSearchParams(new FormData(settingsForm)).toString()
                    });
                    if (!response.ok) throw new Error(`Error del servidor: ${response.statusText}`);
                    status.innerHTML = '<span style="color:green">‚úÖ Configuraci√≥n guardada correctamente.</span>';
                } catch (err) {
                     status.innerHTML = `<span style="color:red">‚ùå Error: ${err.message}</span>`;
                } finally {
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = 'üíæ Guardar Cambios';
                        status.textContent = '';
                    }, 3000);
                }
            });

            document.getElementById('check-ota-btn').addEventListener('click', async () => {
                const status = document.getElementById('ota-status');
                status.textContent = 'Buscando actualizaciones, por favor espere...';
                try {
                    const resp = await fetch('/checkota', { method: 'POST' });
                    const result = await resp.text();
                    status.innerHTML = `<span style="color:blue">‚ÑπÔ∏è ${result}</span>`;
                } catch(e) { status.innerHTML = `<span style="color:red">‚ùå Error de conexi√≥n al buscar actualizaciones.</span>`; }
            });

            document.getElementById('reboot-btn').addEventListener('click', async () => {
                if (confirm('¬øEst√°s seguro de que quieres reiniciar el dispositivo?')) {
                    try {
                        alert('El dispositivo se est√° reiniciando. Perder√°s la conexi√≥n.');
                        await fetch('/reboot', { method: 'POST' });
                    } catch (e) { /* Error de red esperado y normal */ }
                }
            });

            document.getElementById('factory-reset-btn').addEventListener('click', async () => {
                if (confirm('‚ö†Ô∏è ¬°ADVERTENCIA!\nEsto borrar√° TODAS las configuraciones (WiFi incluido) y reiniciar√° el dispositivo a su estado de f√°brica.\n\n¬øEst√°s completamente seguro?')) {
                    try {
                        alert('Restaurando de f√°brica. Perder√°s la conexi√≥n.');
                        await fetch('/factoryreset', { method: 'POST' });
                    } catch (e) { /* Error de red esperado y normal */ }
                }
            });

            // --- L√ìGICA DEL GESTOR DE ARCHIVOS ---
            let currentPath = '/';
            const fileInput = document.getElementById('file-input');
            const fileListDiv = document.getElementById('file-list');
            const pathDisplay = document.getElementById('current-path-display');

            const formatBytes=b=>{if(!+b)return"0 B";const k=1024,s=["B","KB","MB","GB"],i=Math.floor(Math.log(b)/Math.log(k));return`${parseFloat((b/Math.pow(k,i)).toFixed(1))} ${s[i]}`};

            const fetchFileList = async path => {
                currentPath = path;
                pathDisplay.textContent = `üìÅ ${path}`;
                fileListDiv.innerHTML = '<p style="text-align:center;padding:20px;color:#999">Cargando...</p>';
                try {
                    const resp = await fetch(`/listfiles?path=${encodeURIComponent(path)}`);
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    renderFileList(await resp.json(), path);
                } catch (e) { fileListDiv.innerHTML = `<p style="color:red;padding:20px">Error al cargar: ${e.message}</p>`; }
            };

            const handleFileUpload = async files => {
                const pBar = document.getElementById('upload-progress');
                const status = document.getElementById('upload-status');
                if (files.length === 0) return;
                status.textContent = `Subiendo ${files.length} archivo(s)...`;
                let uploaded = 0;
                for (const file of files) {
                    const fd = new FormData();
                    fd.append('path', currentPath);
                    fd.append('file', file, file.name);
                    try {
                        const resp = await fetch('/upload', {method: 'POST', body: fd});
                        if (!resp.ok) throw new Error('Fallo en subida');
                        uploaded++;
                        pBar.style.width = `${(uploaded / files.length) * 100}%`;
                    } catch (e) { status.innerHTML = `<span style="color:red">‚ùå Error al subir ${file.name}</span>`; await new Promise(r=>setTimeout(r,2000)); }
                }
                status.innerHTML = '<span style="color:green">‚úÖ Subida completada.</span>';
                fetchFileList(currentPath);
                setTimeout(() => { pBar.style.width = '0%'; status.textContent = ''; }, 2000);
            };

            const createItem = async (type) => {
                const promptText = type === 'dir' ? 'Nombre de la nueva carpeta:' : 'Nombre del nuevo archivo:';
                const name = prompt(promptText);
                if (!name) return;
                const fd = new FormData();
                fd.append('path', currentPath);
                // [CORRECCI√ìN] Se usa 'dirname' para carpetas y 'filename' para archivos, seg√∫n lo que espera el firmware.
                if (type === 'dir') {
                    fd.append('dirname', name);
                } else {
                    fd.append('filename', name);
                }
                fd.append('type', type);
                try {
                    const resp = await fetch('/create', { method: 'POST', body: fd });
                    if (!resp.ok) throw new Error('El servidor no pudo crear el item.');
                    fetchFileList(currentPath);
                } catch(e) { alert(`Error al crear: ${e.message}`); }
            };

            const renameItem = async (path, oldName) => {
                const newName = prompt(`Nuevo nombre para "${oldName}":`, oldName);
                if (!newName || newName === oldName) return;
                const fd = new FormData(); fd.append('path', path); fd.append('old_filename', oldName); fd.append('new_filename', newName);
                try {
                    const resp = await fetch('/rename', { method: 'POST', body: fd });
                    if (!resp.ok) throw new Error('El servidor no pudo renombrar.');
                    fetchFileList(path);
                } catch(e) { alert(`Error al renombrar: ${e.message}`); }
            };

            const deleteItem = async (path, name) => {
                if (!confirm(`‚ö†Ô∏è ¬øBorrar "${name}"?`)) return;
                const fd = new FormData(); fd.append('path', path); fd.append('filename', name);
                try {
                    const resp = await fetch('/delete', { method: 'POST', body: fd });
                    if (!resp.ok) throw new Error('El servidor no pudo borrar.');
                    fetchFileList(path);
                } catch (e) { alert(`Error al borrar: ${e.message}`); }
            };

            const renderFileList = (files, path) => {
                let html = (path !== '/') ? `<div class="file-item"><div class="file-info"><a href="#" class="dir-link" data-path="${path.substring(0, path.lastIndexOf('/'))||'/'}">‚§¥Ô∏è ..</a></div></div>` : '';
                if (!files || files.length === 0) {
                    fileListDiv.innerHTML = html + '<p style="text-align:center;padding:40px;color:#aaa">Directorio vac√≠o.</p>'; return;
                }
                files.sort((a,b)=>(a.type===b.type)?a.name.localeCompare(b.name):a.type==='dir'?-1:1).forEach(f=>{
                    const icon=f.type==='dir'?'üìÅ':'üìÑ',fullPath=path==='/'?`/${f.name}`:`${path}/${f.name}`;
                    const nameHtml=f.type==='dir'?`<a href="#" class="dir-link" data-path="${fullPath}">${f.name}</a>`:`<span>${f.name} <small style="color:#888">(${formatBytes(f.size)})</small></span>`;
                    html+=`<div class="file-item"><div class="file-info"><span>${icon}</span>${nameHtml}</div><div class="file-actions"><button class="btn btn-small btn-rename" data-path="${path}" data-filename="${f.name}">‚úèÔ∏è</button><button class="btn btn-small btn-danger" data-path="${path}" data-filename="${f.name}">üóëÔ∏è</button></div></div>`;
                });
                fileListDiv.innerHTML = html;
            };

            document.getElementById('upload-btn').addEventListener('click', () => fileInput.click());
            document.getElementById('refresh-btn').addEventListener('click', () => fetchFileList(currentPath));
            document.getElementById('create-folder-btn').addEventListener('click', () => createItem('dir'));
            document.getElementById('create-file-btn').addEventListener('click', () => createItem('file'));
            fileInput.addEventListener('change', e => handleFileUpload(e.target.files));
            ['dragenter','dragover','dragleave','drop'].forEach(e=>fileListDiv.addEventListener(e,evt=>{evt.preventDefault();evt.stopPropagation()}));
            ['dragenter','dragover'].forEach(e=>fileListDiv.addEventListener(e,()=>fileListDiv.classList.add('dragover')));
            ['dragleave','drop'].forEach(e=>fileListDiv.addEventListener(e,()=>fileListDiv.classList.remove('dragover')));
            fileListDiv.addEventListener('drop', e => handleFileUpload(e.dataTransfer.files));
            fileListDiv.addEventListener('click', e => {
                const dirLink=e.target.closest('a.dir-link'),delBtn=e.target.closest('.btn-danger'),renBtn=e.target.closest('.btn-rename');
                if (dirLink) { e.preventDefault(); fetchFileList(dirLink.dataset.path); }
                if (delBtn) { deleteItem(delBtn.dataset.path, delBtn.dataset.filename); }
                if (renBtn) { renameItem(renBtn.dataset.path, renBtn.dataset.filename); }
            });

            // --- L√ìGICA FIYndex ---
            const ICON_EYE = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
            const ICON_EGG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C9.25 2 7 4.25 7 7c0 2.05 1.2 3.8 2.94 4.58C9.37 12.5 9 13.69 9 15c0 2.21 1.79 4 4 4s4-1.79 4-4c0-1.31-.37-2.5-1.06-3.42C15.8 10.8 17 9.05 17 7c0-2.75-2.25-5-5-5zm0 1.5c1.93 0 3.5 1.57 3.5 3.5S13.93 10.5 12 10.5 8.5 8.93 8.5 7 10.07 3.5 12 3.5z"/></svg>`;
            
            const renderFiyndex = (creatures) => {
                const grid = document.getElementById('fiyndex-grid');
                if (!creatures || creatures.length === 0) {
                    grid.innerHTML = '<p>No se encontraron criaturas.</p>';
                    return;
                }
                
                let html = '';
                creatures.forEach(c => {
                    const isLocked = !c.seen && !c.hatched;
                    const name = isLocked ? '???' : c.name;
                    const imageContent = isLocked ? '?' : (c.imageUrl ? `<img src="${c.imageUrl}" alt="${c.name}">` : c.id);

                    html += `
                        <div class="fiy-card ${isLocked ? 'locked' : ''}">
                            <div class="status-icons">
                                <span class="status-icon ${c.seen ? 'unlocked' : ''}" title="Visto">${ICON_EYE}</span>
                                <span class="status-icon ${c.hatched ? 'unlocked' : ''}" title="Criado">${ICON_EGG}</span>
                            </div>
                            <div class="fiy-image">${imageContent}</div>
                            <div class="fiy-info">
                                <h5>${name}</h5>
                                <p>ID: ${c.id}</p>
                            </div>
                            ${!isLocked ? `<a href="https://diytogether.com/editor?id=${c.id}" target="_blank" class="btn-edit">‚úèÔ∏è</a>` : ''}
                        </div>
                    `;
                });
                grid.innerHTML = html;
            };

            const generateMockData = () => {
                const specialCreatures = [
                    { id: 'H', name: 'Huevo', seen: Math.random() > 0.3, hatched: Math.random() > 0.5 },
                    { id: '0', name: 'Neutral', seen: true, hatched: true }
                ];
                
                const primaryEvolutions = [];
                const secondaryEvolutions = [];
                const tertiaryEvolutions = [];

                for (let i = 1; i <= 4; i++) {
                    primaryEvolutions.push({ id: `${i}`, name: `Evo ${i}`, seen: Math.random() > 0.4, hatched: Math.random() > 0.6 });
                    for (let j = 1; j <= 4; j++) {
                        secondaryEvolutions.push({ id: `${i}.${j}`, name: `Evo ${i}.${j}`, seen: Math.random() > 0.5, hatched: Math.random() > 0.7 });
                        for (let k = 1; k <= 4; k++) {
                            tertiaryEvolutions.push({ id: `${i}.${j}.${k}`, name: `Evo ${i}.${j}.${k}`, seen: Math.random() > 0.6, hatched: Math.random() > 0.8 });
                        }
                    }
                }

                const data = [
                    ...specialCreatures,
                    ...primaryEvolutions,
                    ...secondaryEvolutions,
                    ...tertiaryEvolutions
                ];

                return data.map(c => ({
                    ...c, 
                    imageUrl: (!c.seen && !c.hatched) ? null : `https://placehold.co/100x100/667eea/white?text=${c.id}`
                }));
            };

            const loadFiyndexData = async () => {
                const status = document.getElementById('fiyndex-status');
                status.textContent = 'Cargando datos del FIYndex...';
                
                setTimeout(() => { 
                    const mockData = generateMockData();
                    renderFiyndex(mockData);
                    status.textContent = `Mostrando ${mockData.length} entradas.`;
                }, 250);
            };

        });
    </script>
</body>
</html>